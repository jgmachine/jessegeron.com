---
/**
 * BoardGameArena Calendar Heatmap Component
 *
 * GitHub-style contribution calendar showing daily gaming activity.
 * Color intensity shows number of games played, with win rate affecting hue.
 */
import type { BGAPlayHistoryEntry } from "../lib/bga";

interface Props {
  playHistory: BGAPlayHistoryEntry[];
}

const { playHistory } = Astro.props;

// Build a map for quick lookup
const historyMap = new Map<string, BGAPlayHistoryEntry>();
playHistory.forEach((entry) => historyMap.set(entry.date, entry));

// Calculate date range - show last 12 months starting from the 1st of that month
const today = new Date();
const endDate = new Date(today);

// Start from the 1st of the month, 12 months ago
const startDate = new Date(today.getFullYear(), today.getMonth() - 11, 1);

// Adjust to start on a Sunday
while (startDate.getDay() !== 0) {
  startDate.setDate(startDate.getDate() - 1);
}

// Generate all weeks until today
const weeks: Date[][] = [];
let currentDate = new Date(startDate);

while (currentDate <= today) {
  const week: Date[] = [];
  for (let d = 0; d < 7; d++) {
    week.push(new Date(currentDate));
    currentDate.setDate(currentDate.getDate() + 1);
  }
  weeks.push(week);
}

// Get intensity level (0-4) based on game count
function getIntensity(count: number): number {
  if (count === 0) return 0;
  if (count === 1) return 1;
  if (count <= 3) return 2;
  if (count <= 6) return 3;
  return 4;
}

// Format date for display
function formatDate(date: Date): string {
  return date.toISOString().split("T")[0];
}

// Get month labels - only show when there's room (at least 4 weeks between labels)
const monthLabels: { month: string; weekIndex: number }[] = [];
let lastLabeledMonth = -1;
let lastLabelWeekIndex = -10; // Start far back so first label shows

weeks.forEach((week, index) => {
  // Check if any day in this week starts a new month
  for (const day of week) {
    if (day.getDate() <= 7) { // First week of the month
      const month = day.getMonth();
      // Only add label if it's a new month AND we have at least 4 weeks since last label
      if (month !== lastLabeledMonth && (index - lastLabelWeekIndex) >= 4) {
        monthLabels.push({
          month: day.toLocaleDateString("en-US", { month: "short" }),
          weekIndex: index,
        });
        lastLabeledMonth = month;
        lastLabelWeekIndex = index;
      }
      break;
    }
  }
});

// Calculate stats
const totalGames = playHistory.reduce((sum, e) => sum + e.count, 0);
const totalWins = playHistory.reduce((sum, e) => sum + e.wins, 0);
const activeDays = playHistory.length;
---

<div class="bg-white rounded-lg p-5 border border-gray-200 shadow-sm relative" id="bga-heatmap-container">
  <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
    <h3 class="text-lg font-bold text-gray-900">Activity</h3>
    <div class="flex gap-4 text-xs text-gray-600">
      <span><strong class="text-gray-900">{totalGames}</strong> games</span>
      <span><strong class="text-emerald-600">{totalWins}</strong> wins</span>
      <span><strong class="text-gray-900">{activeDays}</strong> active days</span>
    </div>
  </div>

  <!-- Tooltip popup -->
  <div id="heatmap-tooltip" class="hidden absolute z-50 bg-gray-900 text-white rounded-lg shadow-lg p-3 text-sm max-w-xs pointer-events-none">
    <div id="tooltip-date" class="font-bold mb-1"></div>
    <div id="tooltip-stats" class="text-gray-300 mb-2"></div>
    <div id="tooltip-games" class="space-y-1"></div>
  </div>

  <!-- Calendar container -->
  <div class="w-full relative">
    <!-- Month labels row -->
    <div class="flex ml-7 mb-1 relative h-4">
      {monthLabels.map(({ month, weekIndex }) => {
        // Calculate position as percentage
        const leftPercent = (weekIndex / weeks.length) * 100;
        return (
          <div
            class="absolute text-xs text-gray-500"
            style={`left: ${leftPercent}%`}
          >
            {month}
          </div>
        );
      })}
    </div>

    <div class="flex">
      <!-- Day labels -->
      <div class="flex flex-col pr-1 text-[10px] text-gray-400 w-6 flex-shrink-0">
        <div class="h-[11px]"></div>
        <div class="h-[11px] flex items-center">Mon</div>
        <div class="h-[11px]"></div>
        <div class="h-[11px] flex items-center">Wed</div>
        <div class="h-[11px]"></div>
        <div class="h-[11px] flex items-center">Fri</div>
        <div class="h-[11px]"></div>
      </div>

      <!-- Calendar grid - use flex-1 so it fills available space -->
      <div class="flex-1 flex gap-[2px]">
        {weeks.map((week) => (
          <div class="flex-1 flex flex-col gap-[2px]">
            {week.map((date) => {
              const dateStr = formatDate(date);
              const entry = historyMap.get(dateStr);
              const count = entry?.count || 0;
              const wins = entry?.wins || 0;
              const intensity = getIntensity(count);
              const isFuture = date > today;
              const winRate = count > 0 ? Math.round((wins / count) * 100) : 0;

              // Color based on intensity and win rate
              const colors = [
                "bg-gray-100", // 0 games
                winRate >= 50 ? "bg-emerald-200" : "bg-blue-200", // 1 game
                winRate >= 50 ? "bg-emerald-300" : "bg-blue-300", // 2-3 games
                winRate >= 50 ? "bg-emerald-400" : "bg-blue-400", // 4-6 games
                winRate >= 50 ? "bg-emerald-500" : "bg-blue-500", // 7+ games
              ];

              const games = entry?.games || [];
              return (
                <div
                  class={`heatmap-cell aspect-square rounded-sm ${isFuture ? "bg-gray-50" : colors[intensity]} cursor-pointer transition-transform hover:scale-125 hover:ring-1 hover:ring-gray-400`}
                  data-date={dateStr}
                  data-count={count}
                  data-wins={wins}
                  data-games={JSON.stringify(games)}
                />
              );
            })}
          </div>
        ))}
      </div>
    </div>

    <!-- Legend -->
    <div class="flex items-center justify-between mt-3 text-[10px] text-gray-500 flex-wrap gap-2">
      <div class="flex items-center gap-1">
        <span class="text-emerald-500">●</span>
        <span>Win rate ≥ 50%</span>
        <span class="text-blue-500 ml-2">●</span>
        <span>Win rate &lt; 50%</span>
      </div>
      <div class="flex items-center gap-1">
        <span>Less</span>
        <div class="flex gap-[2px]">
          <div class="w-[10px] h-[10px] rounded-sm bg-gray-100" />
          <div class="w-[10px] h-[10px] rounded-sm bg-emerald-200" />
          <div class="w-[10px] h-[10px] rounded-sm bg-emerald-300" />
          <div class="w-[10px] h-[10px] rounded-sm bg-emerald-400" />
          <div class="w-[10px] h-[10px] rounded-sm bg-emerald-500" />
        </div>
        <span>More</span>
      </div>
    </div>
  </div>
</div>

<script>
  const container = document.getElementById('bga-heatmap-container');
  const tooltip = document.getElementById('heatmap-tooltip');
  const tooltipDate = document.getElementById('tooltip-date');
  const tooltipStats = document.getElementById('tooltip-stats');
  const tooltipGames = document.getElementById('tooltip-games');

  if (container && tooltip && tooltipDate && tooltipStats && tooltipGames) {
    const cells = container.querySelectorAll('.heatmap-cell');
    let pinnedCell: Element | null = null;

    function formatDate(dateStr: string): string {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      });
    }

    function showTooltip(cell: Element, isPinned = false) {
      const dateStr = cell.getAttribute('data-date') || '';
      const count = parseInt(cell.getAttribute('data-count') || '0');
      const wins = parseInt(cell.getAttribute('data-wins') || '0');
      const games: string[] = JSON.parse(cell.getAttribute('data-games') || '[]');

      tooltipDate.textContent = formatDate(dateStr);

      if (count > 0) {
        const winRate = Math.round((wins / count) * 100);
        tooltipStats.innerHTML = `
          <span class="text-white">${count}</span> game${count > 1 ? 's' : ''} ·
          <span class="text-emerald-400">${wins}</span> win${wins !== 1 ? 's' : ''} ·
          <span class="${winRate >= 50 ? 'text-emerald-400' : 'text-blue-400'}">${winRate}%</span>
        `;

        if (games.length > 0) {
          // Group games by name and count occurrences
          const gameCounts = new Map<string, number>();
          games.forEach(game => {
            gameCounts.set(game, (gameCounts.get(game) || 0) + 1);
          });

          // Sort by count (descending), then alphabetically
          const sortedGames = Array.from(gameCounts.entries())
            .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));

          tooltipGames.innerHTML = sortedGames.map(([game, playCount]) =>
            `<div class="flex items-center gap-2">
              <span class="text-gray-400">•</span>
              <span>${game}${playCount > 1 ? ` <span class="text-gray-400">×${playCount}</span>` : ''}</span>
            </div>`
          ).join('');
          tooltipGames.classList.remove('hidden');
        } else {
          tooltipGames.classList.add('hidden');
        }
      } else {
        tooltipStats.textContent = 'No games played';
        tooltipGames.classList.add('hidden');
      }

      // Position tooltip
      const rect = cell.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();

      let left = rect.left - containerRect.left + rect.width / 2;
      let top = rect.top - containerRect.top - 8;

      tooltip.classList.remove('hidden');

      // Get tooltip dimensions after showing
      const tooltipRect = tooltip.getBoundingClientRect();

      // Adjust horizontal position to stay within container
      left = left - tooltipRect.width / 2;
      if (left < 0) left = 0;
      if (left + tooltipRect.width > containerRect.width) {
        left = containerRect.width - tooltipRect.width;
      }

      // Position above the cell, or below if not enough room
      top = top - tooltipRect.height;
      if (top < 0) {
        top = rect.bottom - containerRect.top + 8;
      }

      tooltip.style.left = `${left}px`;
      tooltip.style.top = `${top}px`;

      if (isPinned) {
        tooltip.classList.add('ring-2', 'ring-white/30');
      } else {
        tooltip.classList.remove('ring-2', 'ring-white/30');
      }
    }

    function hideTooltip() {
      if (!pinnedCell) {
        tooltip.classList.add('hidden');
      }
    }

    cells.forEach(cell => {
      const count = parseInt(cell.getAttribute('data-count') || '0');

      // Only add interactions for days with games played
      if (count > 0) {
        cell.addEventListener('mouseenter', () => {
          if (!pinnedCell) {
            showTooltip(cell);
          }
        });

        cell.addEventListener('mouseleave', () => {
          hideTooltip();
        });

        cell.addEventListener('click', (e) => {
          e.stopPropagation();
          if (pinnedCell === cell) {
            // Unpin if clicking the same cell
            pinnedCell = null;
            tooltip.classList.add('hidden');
          } else {
            // Pin to this cell
            pinnedCell = cell;
            showTooltip(cell, true);
          }
        });
      }
    });

    // Click outside to unpin
    document.addEventListener('click', () => {
      if (pinnedCell) {
        pinnedCell = null;
        tooltip.classList.add('hidden');
      }
    });
  }
</script>
