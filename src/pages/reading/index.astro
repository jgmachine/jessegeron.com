---
import Layout from '../../layouts/Layout.astro';
import Card from '../../components/Card.astro';
import PageHeaderBackground from '../../components/PageHeaderBackground.astro';
import AffiliateDisclosure from '../../components/AffiliateDisclosure.astro';
import { getCollection } from 'astro:content';

const AFFILIATE_TAG = 'jgeron-20';

// Helper to generate Amazon affiliate link
function getAmazonLink(asin: string) {
  return `https://www.amazon.com/dp/${asin}?tag=${AFFILIATE_TAG}`;
}

const allBooks = await getCollection('books');

// Sort books by date read
const books = allBooks.sort((a, b) => {
  if (!a.data.dateRead) return 1;
  if (!b.data.dateRead) return -1;
  return b.data.dateRead.valueOf() - a.data.dateRead.valueOf();
});

// Get unique categories, tags, and work/play from ALL books
const allCategories = [...new Set(allBooks.map(book => book.data.category))].sort();
const allTags = [...new Set(allBooks.flatMap(book => book.data.tags))].sort();
const workPlayCategories = ['Work', 'Play'];
const statuses = ['reading', 'read', 'to-read'];

// Group books by status
const currentlyReading = books.filter(b => b.data.status === 'reading');
const haveRead = books.filter(b => b.data.status === 'read');
const toRead = books.filter(b => b.data.status === 'to-read');
---

<Layout title="Reading List - Jesse Geron" description="Books I'm reading and recommend">
  <!-- Header with animated background -->
  <section class="relative py-20 overflow-hidden">
    <PageHeaderBackground />
    <div class="relative z-10 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="text-center">
        <h1 class="text-5xl sm:text-6xl font-black text-gray-900 mb-6">
          <span class="gradient-text">Reading List</span>
        </h1>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
          Books spanning leadership, technology, AI, and personal interests
        </p>
      </header>
    </div>
  </section>

  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">

    <!-- Filter Section -->
    <div class="mb-8 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <button id="toggleFilters" class="flex items-center gap-2 text-base font-semibold text-gray-900 hover:text-blue-600 transition-colors">
          <svg id="filterChevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
          Filters
        </button>
        <button id="clearFilters" class="hidden text-xs text-blue-600 hover:underline">
          Clear All
        </button>
      </div>
      
      <div id="filterContent" class="space-y-2 mt-3 hidden">
        <!-- Topic & Status in one line -->
        <div class="flex flex-wrap gap-2 items-center">
          <button
            data-filter-type="all"
            class="filter-btn px-3 py-1 rounded-full text-xs font-medium transition bg-blue-600 text-white"
          >
            All Books
          </button>
          {workPlayCategories.map((wpCat) => (
            <button
              data-filter-type="workplay"
              data-filter-value={wpCat}
              class="filter-btn px-3 py-1 rounded-full text-xs font-medium transition bg-gray-100 text-gray-900 hover:bg-gray-200"
            >
              {wpCat}
            </button>
          ))}
          <span class="text-gray-300">|</span>
          {statuses.map((status) => (
            <button
              data-filter-type="status"
              data-filter-value={status}
              class="filter-btn px-3 py-1 rounded-full text-xs font-medium border transition bg-purple-50 text-purple-700 border-purple-200 hover:bg-purple-100"
            >
              {status === 'reading' ? 'Reading' : status === 'to-read' ? 'Want' : 'Read'}
            </button>
          ))}
        </div>

        <!-- Categories -->
        <div class="flex flex-wrap gap-1.5">
          {allCategories.map((category) => (
            <button
              data-filter-type="category"
              data-filter-value={category}
              class="filter-btn px-2.5 py-1 rounded text-xs font-medium transition bg-gray-100 text-gray-700 hover:bg-blue-50 hover:text-blue-700 border border-gray-200 hover:border-blue-200"
            >
              {category}
            </button>
          ))}
        </div>

        <!-- Tags -->
        <div class="flex flex-wrap gap-1.5">
          {allTags.map((tag) => (
            <button
              data-filter-type="tag"
              data-filter-value={tag}
              class="filter-btn px-2.5 py-1 rounded text-xs font-medium border transition bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100"
            >
              #{tag}
            </button>
          ))}
        </div>
      </div>
    </div>

    <!-- Currently Reading -->
    <section class="mb-16 book-section" data-status="reading">
      <h2 class="text-3xl font-bold text-gray-900 mb-8">Currently Reading</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {currentlyReading.map((book) => (
          <a
            href={`/reading/${book.slug}`}
            class="book-card block group"
            data-status={book.data.status}
            data-category={book.data.category}
            data-workplay={book.data.workPlayCategory}
            data-tags={book.data.tags.join(',')}
          >
            <article class="card card-hover p-8 h-full">
              <div class="flex items-start gap-4">
                {book.data.coverUrl && (
                  <img
                    src={book.data.coverUrl}
                    alt={book.data.title}
                    class="w-16 h-24 object-cover rounded shadow-sm"
                    loading="lazy"
                  />
                )}
                <div class="flex-1">
                  <h3 class="text-xl font-bold text-gray-900 group-hover:text-blue-600 transition-colors mb-2">
                    {book.data.title}
                  </h3>
                  <p class="text-sm text-gray-600 mb-2">{book.data.author}</p>
                  {book.data.series && book.data.seriesPosition && book.data.seriesTotal && (
                    <div class="mb-3">
                      <p class="text-xs text-gray-500 mb-1">{book.data.series} ({book.data.seriesPosition}/{book.data.seriesTotal})</p>
                      <div class="flex gap-1">
                        {Array.from({ length: book.data.seriesTotal }, (_, i) => (
                          <div
                            class={`h-1.5 w-1.5 rounded-full ${
                              i < book.data.seriesPosition ? 'bg-green-500' : 'bg-gray-300'
                            }`}
                          ></div>
                        ))}
                      </div>
                    </div>
                  )}
                  {book.data.description && (
                    <p class="text-sm text-gray-700 mb-3">{book.data.description}</p>
                  )}
                  <span class="px-3 py-1.5 bg-green-50 text-green-700 text-xs font-semibold rounded-full border border-green-200">
                    Reading
                  </span>
                </div>
              </div>
            </article>
          </a>
        ))}
      </div>
    </section>

    <!-- Have Read -->
    <section class="mb-16 book-section" data-status="read">
      <h2 class="text-3xl font-bold text-gray-900 mb-8">Have Read</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {haveRead.map((book) => (
          <a
            href={`/reading/${book.slug}`}
            class="book-card block group"
            data-status={book.data.status}
            data-category={book.data.category}
            data-workplay={book.data.workPlayCategory}
            data-tags={book.data.tags.join(',')}
          >
            <article class="card card-hover p-8 h-full">
              <div class="flex items-start gap-4">
                {book.data.coverUrl && (
                  <img
                    src={book.data.coverUrl}
                    alt={book.data.title}
                    class="w-16 h-24 object-cover rounded shadow-sm"
                    loading="lazy"
                  />
                )}
                <div class="flex-1">
                  <h3 class="text-xl font-bold text-gray-900 group-hover:text-blue-600 transition-colors mb-2">
                    {book.data.title}
                  </h3>
                  <p class="text-sm text-gray-600 mb-2">{book.data.author}</p>
                  {book.data.series && book.data.seriesPosition && book.data.seriesTotal && (
                    <div class="mb-3">
                      <p class="text-xs text-gray-500 mb-1">{book.data.series} ({book.data.seriesPosition}/{book.data.seriesTotal})</p>
                      <div class="flex gap-1">
                        {Array.from({ length: book.data.seriesTotal }, (_, i) => (
                          <div
                            class={`h-1.5 w-1.5 rounded-full ${
                              i < book.data.seriesPosition ? 'bg-blue-500' : 'bg-gray-300'
                            }`}
                          ></div>
                        ))}
                      </div>
                    </div>
                  )}
                  {book.data.summary && (
                    <p class="text-sm text-gray-700">{book.data.summary}</p>
                  )}
                </div>
              </div>
            </article>
          </a>
        ))}
      </div>
    </section>

    <!-- Want to Read -->
    <section class="mb-16 book-section" data-status="to-read">
      <h2 class="text-3xl font-bold text-gray-900 mb-8">Want to Read</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {toRead.map((book) => (
          <a
            href={`/reading/${book.slug}`}
            class="book-card block group"
            data-status={book.data.status}
            data-category={book.data.category}
            data-workplay={book.data.workPlayCategory}
            data-tags={book.data.tags.join(',')}
          >
            <article class="card card-hover p-8 h-full">
              <div class="flex items-start gap-4">
                {book.data.coverUrl && (
                  <img
                    src={book.data.coverUrl}
                    alt={book.data.title}
                    class="w-16 h-24 object-cover rounded shadow-sm"
                    loading="lazy"
                  />
                )}
                <div class="flex-1">
                  <h3 class="text-xl font-bold text-gray-900 group-hover:text-blue-600 transition-colors mb-2">
                    {book.data.title}
                  </h3>
                  <p class="text-sm text-gray-600 mb-2">{book.data.author}</p>
                  {book.data.series && book.data.seriesPosition && book.data.seriesTotal && (
                    <div class="mb-3">
                      <p class="text-xs text-gray-500 mb-1">{book.data.series} ({book.data.seriesPosition}/{book.data.seriesTotal})</p>
                      <div class="flex gap-1">
                        {Array.from({ length: book.data.seriesTotal }, (_, i) => (
                          <div
                            class={`h-1.5 w-1.5 rounded-full ${
                              i < book.data.seriesPosition ? 'bg-yellow-500' : 'bg-gray-300'
                            }`}
                          ></div>
                        ))}
                      </div>
                    </div>
                  )}
                  {book.data.description && (
                    <p class="text-sm text-gray-700">{book.data.description}</p>
                  )}
                </div>
              </div>
            </article>
          </a>
        ))}
      </div>
    </section>

    <div id="noResults" class="hidden text-center py-16">
      <p class="text-gray-600 text-lg">No books found matching your filters.</p>
    </div>

  </div>
</Layout>

<script>
  let activeFilters = {
    workplay: null as string | null,
    category: null as string | null,
    status: null as string | null,
    tag: null as string | null
  };

  // Toggle filter panel
  const toggleBtn = document.getElementById('toggleFilters');
  const filterContent = document.getElementById('filterContent');
  const filterChevron = document.getElementById('filterChevron');
  
  toggleBtn?.addEventListener('click', () => {
    filterContent?.classList.toggle('hidden');
    filterChevron?.classList.toggle('rotate-180');
  });

  function applyFilters() {
    const books = document.querySelectorAll('.book-card');
    const sections = document.querySelectorAll('.book-section');
    let visibleCount = 0;

    books.forEach(book => {
      const bookEl = book as HTMLElement;
      let visible = true;

      if (activeFilters.workplay && bookEl.dataset.workplay !== activeFilters.workplay) {
        visible = false;
      }
      if (activeFilters.category && bookEl.dataset.category !== activeFilters.category) {
        visible = false;
      }
      if (activeFilters.status && bookEl.dataset.status !== activeFilters.status) {
        visible = false;
      }
      if (activeFilters.tag && !bookEl.dataset.tags?.split(',').includes(activeFilters.tag)) {
        visible = false;
      }

      bookEl.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });

    // Show/hide sections based on whether they have visible books
    sections.forEach(section => {
      const sectionEl = section as HTMLElement;
      const visibleBooks = sectionEl.querySelectorAll('.book-card:not([style*="display: none"])');
      sectionEl.style.display = visibleBooks.length > 0 ? '' : 'none';
    });

    // Show/hide no results message
    const noResults = document.getElementById('noResults');
    if (noResults) {
      noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }

    // Show/hide clear filters button
    const clearBtn = document.getElementById('clearFilters');
    const hasActiveFilters = Object.values(activeFilters).some(v => v !== null);
    if (clearBtn) {
      clearBtn.classList.toggle('hidden', !hasActiveFilters);
    }

    // Update button styles
    document.querySelectorAll('.filter-btn').forEach(btn => {
      const btnEl = btn as HTMLElement;
      const filterType = btnEl.dataset.filterType;
      const filterValue = btnEl.dataset.filterValue;
      
      let isActive = false;
      if (filterType === 'all') {
        isActive = !hasActiveFilters;
      } else if (filterType && activeFilters[filterType as keyof typeof activeFilters] === filterValue) {
        isActive = true;
      }

      // Update classes
      if (isActive) {
        btnEl.classList.remove('bg-gray-100', 'bg-purple-50', 'bg-blue-50');
        btnEl.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
      } else {
        btnEl.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
        if (filterType === 'workplay' || filterType === 'all') {
          if (!btnEl.classList.contains('bg-gray-100')) {
            btnEl.classList.add('bg-gray-100');
          }
        }
      }
    });
  }

  // Handle filter button clicks
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      const filterType = target.dataset.filterType;
      const filterValue = target.dataset.filterValue;

      if (filterType === 'all') {
        activeFilters = { workplay: null, category: null, status: null, tag: null };
      } else if (filterType) {
        const key = filterType as keyof typeof activeFilters;
        activeFilters[key] = activeFilters[key] === filterValue ? null : (filterValue || null);
      }

      applyFilters();
    });
  });

  // Clear filters button
  document.getElementById('clearFilters')?.addEventListener('click', () => {
    activeFilters = { workplay: null, category: null, status: null, tag: null };
    applyFilters();
  });

  // Apply filters on page load
  applyFilters();
</script>

<!-- Affiliate Disclosure Footer -->
<footer class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-8">
  <div class="text-center">
    <AffiliateDisclosure variant="compact" />
  </div>
</footer>