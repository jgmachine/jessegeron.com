---
import Layout from '../../layouts/Layout.astro';
import Card from '../../components/Card.astro';
import { getCollection } from 'astro:content';

const allBooks = await getCollection('books');

// Sort books by date read
const books = allBooks.sort((a, b) => {
  if (!a.data.dateRead) return 1;
  if (!b.data.dateRead) return -1;
  return b.data.dateRead.valueOf() - a.data.dateRead.valueOf();
});

// Get unique categories, tags, and work/play from ALL books
const allCategories = [...new Set(allBooks.map(book => book.data.category))].sort();
const allTags = [...new Set(allBooks.flatMap(book => book.data.tags))].sort();
const workPlayCategories = ['Work', 'Play'];
const statuses = ['reading', 'read', 'to-read'];

// Group books by status
const currentlyReading = books.filter(b => b.data.status === 'reading');
const haveRead = books.filter(b => b.data.status === 'read');
const toRead = books.filter(b => b.data.status === 'to-read');
---

<Layout title="Reading List - Jesse Geron" description="Books I'm reading and recommend">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

    <header class="mb-12">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">Reading List</h1>
      <p class="text-xl text-gray-600 dark:text-gray-300">
        Books spanning leadership, technology, AI, and personal interests
      </p>
    </header>

    <!-- Filter Section -->
    <div class="mb-8 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Filter by Topic</h2>
        <button id="clearFilters" class="hidden text-sm text-blue-600 dark:text-blue-400 hover:underline">
          Clear Filters
        </button>
      </div>
      
      <div class="flex flex-wrap gap-2 mb-6">
        <button 
          data-filter-type="all"
          class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition bg-blue-600 text-white"
        >
          All Books
        </button>
        {workPlayCategories.map((wpCat) => (
          <button 
            data-filter-type="workplay"
            data-filter-value={wpCat}
            class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-300 dark:hover:bg-gray-600"
          >
            {wpCat}
          </button>
        ))}
      </div>

      <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Categories</h3>
      <div class="flex flex-wrap gap-2 mb-6">
        {allCategories.map((category) => (
          <button 
            data-filter-type="category"
            data-filter-value={category}
            class="filter-btn px-3 py-1 rounded-full text-sm transition bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"
          >
            {category}
          </button>
        ))}
      </div>

      <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Status</h3>
      <div class="flex flex-wrap gap-2 mb-6">
        {statuses.map((status) => (
          <button 
            data-filter-type="status"
            data-filter-value={status}
            class="filter-btn px-3 py-1 rounded-full text-sm border transition bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 border-purple-200 dark:border-purple-800 hover:bg-purple-100 dark:hover:bg-purple-900/50"
          >
            {status === 'reading' ? 'Currently Reading' : status === 'to-read' ? 'Want to Read' : 'Have Read'}
          </button>
        ))}
      </div>

      <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Tags</h3>
      <div class="flex flex-wrap gap-2">
        {allTags.map((tag) => (
          <button 
            data-filter-type="tag"
            data-filter-value={tag}
            class="filter-btn px-3 py-1 rounded-full text-sm border transition bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border-blue-200 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-900/50"
          >
            #{tag}
          </button>
        ))}
      </div>
    </div>

    <!-- Currently Reading -->
    <section class="mb-12 book-section" data-status="reading">
      <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Currently Reading</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {currentlyReading.map((book) => (
          <a 
            href={`/reading/${book.slug}`} 
            class="book-card block group" 
            data-status={book.data.status}
            data-category={book.data.category}
            data-workplay={book.data.workPlayCategory}
            data-tags={book.data.tags.join(',')}
          >
            <article class="card card-hover rounded-xl p-6 h-full hover-lift">
              <div class="flex items-start gap-4">
                {book.data.coverImage && (
                  <img src={book.data.coverImage} alt={book.data.title} class="w-16 h-24 object-cover rounded" />
                )}
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition mb-2">
                    {book.data.title}
                  </h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">{book.data.author}</p>
                  <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 text-xs rounded-full">
                    Reading
                  </span>
                </div>
              </div>
            </article>
          </a>
        ))}
      </div>
    </section>

    <!-- Have Read -->
    <section class="mb-12 book-section" data-status="read">
      <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Have Read</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {haveRead.map((book) => (
          <a 
            href={`/reading/${book.slug}`} 
            class="book-card block group"
            data-status={book.data.status}
            data-category={book.data.category}
            data-workplay={book.data.workPlayCategory}
            data-tags={book.data.tags.join(',')}
          >
            <article class="card card-hover rounded-xl p-6 h-full hover-lift">
              <div class="flex items-start gap-4">
                {book.data.coverImage && (
                  <img src={book.data.coverImage} alt={book.data.title} class="w-16 h-24 object-cover rounded" />
                )}
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition mb-2">
                    {book.data.title}
                  </h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">{book.data.author}</p>
                </div>
              </div>
            </article>
          </a>
        ))}
      </div>
    </section>

    <!-- Want to Read -->
    <section class="mb-12 book-section" data-status="to-read">
      <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Want to Read</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {toRead.map((book) => (
          <a 
            href={`/reading/${book.slug}`} 
            class="book-card block group"
            data-status={book.data.status}
            data-category={book.data.category}
            data-workplay={book.data.workPlayCategory}
            data-tags={book.data.tags.join(',')}
          >
            <article class="card card-hover rounded-xl p-6 h-full hover-lift">
              <div class="flex items-start gap-4">
                {book.data.coverImage && (
                  <img src={book.data.coverImage} alt={book.data.title} class="w-16 h-24 object-cover rounded" />
                )}
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition mb-2">
                    {book.data.title}
                  </h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400">{book.data.author}</p>
                </div>
              </div>
            </article>
          </a>
        ))}
      </div>
    </section>

    <div id="noResults" class="hidden text-center py-12">
      <p class="text-gray-600 dark:text-gray-400 text-lg">No books found matching your filters.</p>
    </div>

  </div>
</Layout>

<script>
  let activeFilters = {
    workplay: null as string | null,
    category: null as string | null,
    status: null as string | null,
    tag: null as string | null
  };

  function applyFilters() {
    const books = document.querySelectorAll('.book-card');
    const sections = document.querySelectorAll('.book-section');
    let visibleCount = 0;

    books.forEach(book => {
      const bookEl = book as HTMLElement;
      let visible = true;

      if (activeFilters.workplay && bookEl.dataset.workplay !== activeFilters.workplay) {
        visible = false;
      }
      if (activeFilters.category && bookEl.dataset.category !== activeFilters.category) {
        visible = false;
      }
      if (activeFilters.status && bookEl.dataset.status !== activeFilters.status) {
        visible = false;
      }
      if (activeFilters.tag && !bookEl.dataset.tags?.split(',').includes(activeFilters.tag)) {
        visible = false;
      }

      bookEl.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });

    // Show/hide sections based on whether they have visible books
    sections.forEach(section => {
      const sectionEl = section as HTMLElement;
      const visibleBooks = sectionEl.querySelectorAll('.book-card:not([style*="display: none"])');
      sectionEl.style.display = visibleBooks.length > 0 ? '' : 'none';
    });

    // Show/hide no results message
    const noResults = document.getElementById('noResults');
    if (noResults) {
      noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }

    // Show/hide clear filters button
    const clearBtn = document.getElementById('clearFilters');
    const hasActiveFilters = Object.values(activeFilters).some(v => v !== null);
    if (clearBtn) {
      clearBtn.classList.toggle('hidden', !hasActiveFilters);
    }

    // Update button styles
    document.querySelectorAll('.filter-btn').forEach(btn => {
      const btnEl = btn as HTMLElement;
      const filterType = btnEl.dataset.filterType;
      const filterValue = btnEl.dataset.filterValue;
      
      let isActive = false;
      if (filterType === 'all') {
        isActive = !hasActiveFilters;
      } else if (filterType && activeFilters[filterType as keyof typeof activeFilters] === filterValue) {
        isActive = true;
      }

      // Update classes
      if (isActive) {
        btnEl.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'bg-gray-100', 'bg-purple-50', 'dark:bg-purple-900/30', 'bg-blue-50', 'dark:bg-blue-900/30');
        btnEl.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
      } else {
        btnEl.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
        if (filterType === 'workplay' || filterType === 'all') {
          if (!btnEl.classList.contains('bg-gray-200')) {
            btnEl.classList.add('bg-gray-200', 'dark:bg-gray-700');
          }
        }
      }
    });
  }

  // Handle filter button clicks
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      const filterType = target.dataset.filterType;
      const filterValue = target.dataset.filterValue;

      if (filterType === 'all') {
        activeFilters = { workplay: null, category: null, status: null, tag: null };
      } else if (filterType) {
        const key = filterType as keyof typeof activeFilters;
        activeFilters[key] = activeFilters[key] === filterValue ? null : (filterValue || null);
      }

      applyFilters();
    });
  });

  // Clear filters button
  document.getElementById('clearFilters')?.addEventListener('click', () => {
    activeFilters = { workplay: null, category: null, status: null, tag: null };
    applyFilters();
  });

  // Apply filters on page load
  applyFilters();
</script>ection>
    )}

    {books.length === 0 && (
      <div class="text-center py-12">
        <p class="text-gray-600 dark:text-gray-400 text-lg">No books found.</p>
      </div>
    )}

  </div>
</Layout>
